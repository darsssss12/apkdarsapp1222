<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DARSAP Premium Chat & Call</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --wa-bg: #0b141a; --wa-sidebar: #111b21; --wa-header: #202c33;
            --wa-green: #00a884; --wa-msg-out: #005c4b; --wa-text: #e9edef;
            --wa-dim: #8696a0; --accent: #00a884;
        }

        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--wa-bg); color: var(--wa-text); height: 100vh; overflow: hidden; }

        /* --- LAYOUT --- */
        .app-container { display: flex; width: 100vw; height: 100vh; position: relative; }
        
        .sidebar { 
            width: 350px; background: var(--wa-sidebar); border-right: 1px solid #222d34; 
            display: flex; flex-direction: column; transition: 0.3s;
        }

        .chat-main { 
            flex: 1; display: flex; flex-direction: column; 
            background: #0b141a url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-blend-mode: overlay; position: relative;
        }

        @media (max-width: 768px) {
            .sidebar { width: 100%; position: absolute; left: 0; z-index: 5; }
            .chat-main { width: 100%; position: absolute; left: 100%; z-index: 10; transition: 0.3s; }
            .chat-main.active { left: 0; }
        }

        /* --- UI COMPONENTS --- */
        .header { height: 60px; background: var(--wa-header); padding: 10px 15px; display: flex; align-items: center; gap: 12px; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; background: #53616a; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; }
        
        .btn-add { background: var(--wa-green); color: white; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-weight: bold; }
        
        .contact-item { padding: 12px 15px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid #222d34; cursor: pointer; }
        .contact-item:hover { background: #202c33; }

        .chat-header-btns { margin-left: auto; display: flex; gap: 20px; font-size: 20px; }
        .chat-header-btns span { cursor: pointer; padding: 5px; transition: 0.2s; }
        .chat-header-btns span:hover { color: var(--wa-green); }

        .messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .msg { max-width: 70%; padding: 8px 12px; border-radius: 8px; font-size: 14.5px; position: relative; line-height: 1.4; }
        .msg.in { background: #202c33; align-self: flex-start; }
        .msg.out { background: var(--wa-msg-out); align-self: flex-end; }
        .msg-time { font-size: 10px; color: var(--wa-dim); float: right; margin-top: 5px; margin-left: 10px; }

        .input-bar { padding: 10px 15px; background: var(--wa-header); display: flex; align-items: center; gap: 10px; }
        .input-bar input { flex: 1; background: #2a3942; border: none; padding: 12px 18px; border-radius: 25px; color: white; outline: none; }

        /* --- MODAL TAMBAH KONTAK --- */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; display: none; align-items: center; justify-content: center; }
        .modal { background: var(--wa-header); padding: 25px; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; }
        .modal input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: none; background: #2a3942; color: white; }
        .modal-btns { display: flex; gap: 10px; margin-top: 15px; }
        .modal-btns button { flex: 1; padding: 10px; border-radius: 8px; border: none; cursor: pointer; }

        /* --- CALL SCREEN --- */
        #callUI { position: fixed; inset: 0; background: #0b141a; z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        #remoteVideo { width: 100%; height: 100%; object-fit: cover; }
        #localVideo { position: absolute; top: 20px; right: 20px; width: 100px; height: 140px; border-radius: 10px; border: 2px solid white; z-index: 1100; }
        .call-actions { position: absolute; bottom: 50px; display: flex; gap: 20px; }
        .btn-call { width: 60px; height: 60px; border-radius: 50%; border: none; cursor: pointer; font-size: 24px; color: white; }

        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: grey; }
        .online { background: var(--wa-green) !important; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="sidebar" id="sidebar">
        <div class="header">
            <div id="myIdDisplay" style="font-size: 11px; flex: 1;">ID: ...</div>
            <button class="btn-add" onclick="toggleModal(true)">+ Tambah</button>
        </div>
        <div id="contactList" style="flex: 1; overflow-y: auto;"></div>
    </div>

    <div class="chat-main" id="chatMain">
        <div id="noChatSelected" style="margin: auto; text-align: center; color: var(--wa-dim);">
            <h2>DARSAP  Chat</h2>
            <p>Pilih kontak atau tambahkan teman dengan ID mereka.</p>
        </div>

        <div id="activeChatUI" class="active-chat" style="display: none; flex-direction: column; height: 100%;">
            <div class="header">
                <span onclick="goBack()" style="cursor:pointer; display:none;" class="mobile-only">‚¨ÖÔ∏è</span>
                <div class="avatar" id="headerAvatar">?</div>
                <div style="flex: 1;">
                    <b id="headerName">...</b><br>
                    <small id="headerStatus">offline</small>
                </div>
                <div class="chat-header-btns">
                    <span title="Voice Call" onclick="startCall(false)">üìû</span>
                    <span title="Video Call" onclick="startCall(true)">üìπ</span>
                </div>
            </div>

            <div class="messages" id="messageList"></div>

            <form class="input-bar" id="chatForm">
                <input type="text" id="msgInput" placeholder="Ketik pesan..." autocomplete="off">
                <button type="submit" style="background:none; border:none; color:var(--wa-green); font-size:25px; cursor:pointer;">‚û§</button>
            </form>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modalOverlay">
    <div class="modal">
        <h3>Tambah Teman Baru</h3>
        <input type="text" id="friendName" placeholder="Nama Panggilan">
        <input type="text" id="friendId" placeholder="Masukkan ID PeerJS Teman">
        <div class="modal-btns">
            <button onclick="toggleModal(false)" style="background: #3b4a54; color: white;">Batal</button>
            <button onclick="saveFriend()" style="background: var(--wa-green); color: white;">Simpan</button>
        </div>
    </div>
</div>

<div id="callUI">
    <div id="callInfo" style="position: absolute; top: 50px; text-align: center; z-index: 1200;">
        <h2 id="callingUser">Memanggil...</h2>
        <span id="callType">Voice Call</span>
    </div>
    <video id="remoteVideo" autoplay playsinline></video>
    <video id="localVideo" autoplay playsinline muted></video>
    <div class="call-actions">
        <button class="btn-call" style="background: #3b4a54;" onclick="toggleMute()">üéôÔ∏è</button>
        <button class="btn-call" style="background: #ff3b30;" onclick="endCall()">‚ùå</button>
    </div>
</div>

<audio id="ringtone" src="https://actions.google.com/sounds/v1/alarms/phone_alerts_and_rings.ogg" loop></audio>

<script>
    let peer, myID, activeContact;
    let connections = {};
    let currentCall = null;
    let localStream = null;

    let contacts = JSON.parse(localStorage.getItem('darsap_contacts_v2') || '[]');
    let chatHistory = JSON.parse(localStorage.getItem('darsap_history_v2') || '{}');

    // --- SETUP PEER ---
    window.onload = () => {
        myID = localStorage.getItem('my_wa_id') || Math.random().toString(36).substr(2, 6);
        if(!localStorage.getItem('my_wa_id')) {
            let input = prompt("Buat ID kamu (contoh: andi77):", myID);
            myID = input || myID;
            localStorage.setItem('my_wa_id', myID);
        }
        
        peer = new Peer(myID);
        peer.on('open', id => document.getElementById('myIdDisplay').innerText = "ID SAYA: " + id);
        
        // Terima Pesan
        peer.on('connection', conn => handleDataConnection(conn));

        // Terima Telepon/VC
        peer.on('call', async call => {
            if(confirm("Panggilan Masuk dari " + call.peer + ". Terima?")) {
                document.getElementById('ringtone').play();
                const isVideo = call.options.metadata?.video || false;
                await getMedia(isVideo);
                call.answer(localStream);
                handleCall(call);
            }
        });

        renderContacts();
    };

    // --- MANAJEMEN KONTAK & MODAL ---
    function toggleModal(show) {
        document.getElementById('modalOverlay').style.display = show ? 'flex' : 'none';
    }

    function saveFriend() {
        const name = document.getElementById('friendName').value;
        const id = document.getElementById('friendId').value;
        if(name && id) {
            contacts.push({ name, id });
            localStorage.setItem('darsap_contacts_v2', JSON.stringify(contacts));
            renderContacts();
            toggleModal(false);
            document.getElementById('friendName').value = '';
            document.getElementById('friendId').value = '';
        }
    }

    function renderContacts() {
        const list = document.getElementById('contactList');
        list.innerHTML = "";
        contacts.forEach(c => {
            const el = document.createElement('div');
            el.className = "contact-item";
            el.onclick = () => selectChat(c);
            el.innerHTML = `<div class="avatar">${c.name[0]}</div><div><b>${c.name}</b><br><small style="color:var(--wa-dim)">ID: ${c.id}</small></div>`;
            list.appendChild(el);
        });
    }

    // --- CHAT LOGIC ---
    function selectChat(contact) {
        activeContact = contact;
        document.getElementById('noChatSelected').style.display = 'none';
        document.getElementById('activeChatUI').style.display = 'flex';
        document.getElementById('chatMain').classList.add('active'); // mobile view
        document.getElementById('headerName').innerText = contact.name;
        document.getElementById('headerAvatar').innerText = contact.name[0];
        
        renderMessages();

        // Buat koneksi data jika belum ada
        if(!connections[contact.id]) {
            const conn = peer.connect(contact.id);
            handleDataConnection(conn);
        }
    }

    function handleDataConnection(conn) {
        connections[conn.peer] = conn;
        conn.on('open', () => {
            if(activeContact?.id === conn.peer) document.getElementById('headerStatus').innerText = "Online";
        });
        conn.on('data', data => {
            saveMessage(conn.peer, 'in', data);
            if(activeContact?.id === conn.peer) renderMessages();
        });
    }

    document.getElementById('chatForm').onsubmit = (e) => {
        e.preventDefault();
        const input = document.getElementById('msgInput');
        const text = input.value.trim();
        if(!text || !activeContact) return;

        const conn = connections[activeContact.id];
        if(conn && conn.open) {
            conn.send(text);
            saveMessage(activeContact.id, 'out', text);
            renderMessages();
            input.value = "";
        } else {
            alert("Sedang menghubungkan ke teman...");
        }
    };

    function saveMessage(id, type, text) {
        if(!chatHistory[id]) chatHistory[id] = [];
        chatHistory[id].push({ type, text, time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) });
        localStorage.setItem('darsap_history_v2', JSON.stringify(chatHistory));
    }

    function renderMessages() {
        const box = document.getElementById('messageList');
        box.innerHTML = "";
        (chatHistory[activeContact.id] || []).forEach(m => {
            const div = document.createElement('div');
            div.className = `msg ${m.type}`;
            div.innerHTML = `${m.text} <span class="msg-time">${m.time}</span>`;
            box.appendChild(div);
        });
        box.scrollTop = box.scrollHeight;
    }

    // --- CALL / VC LOGIC ---
    async function getMedia(video) {
        localStream = await navigator.mediaDevices.getUserMedia({ video, audio: true });
        document.getElementById('localVideo').srcObject = localStream;
        document.getElementById('localVideo').style.display = video ? 'block' : 'none';
    }

    async function startCall(video) {
        if(!activeContact) return;
        await getMedia(video);
        document.getElementById('callUI').style.display = 'flex';
        document.getElementById('callingUser').innerText = activeContact.name;
        document.getElementById('callType').innerText = video ? "Video Call" : "Voice Call";
        
        const call = peer.call(activeContact.id, localStream, { metadata: { video: video } });
        handleCall(call);
    }

    function handleCall(call) {
        currentCall = call;
        call.on('stream', rs => {
            document.getElementById('ringtone').pause();
            document.getElementById('remoteVideo').srcObject = rs;
        });
        call.on('close', endCall);
    }

    function endCall() {
        if(currentCall) currentCall.close();
        if(localStream) localStream.getTracks().forEach(t => t.stop());
        document.getElementById('callUI').style.display = 'none';
        document.getElementById('ringtone').pause();
    }

    function toggleMute() {
        const track = localStream.getAudioTracks()[0];
        track.enabled = !track.enabled;
    }

    function goBack() {
        document.getElementById('chatMain').classList.remove('active');
    }
</script>
</body>
</html>
