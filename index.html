<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DARSAP v6 - Global Connect</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --primary: #00a884; --header-bg: #f0f2f5; --sidebar-bg: #ffffff;
            --chat-bg: #e5ddd5; --msg-out: #d9fdd3; --msg-in: #ffffff;
            --text-main: #111b21; --text-sec: #667781;
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', Roboto, sans-serif; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #f0f2f5; }

        .app-container { display: flex; width: 100vw; height: 100vh; position: relative; }

        /* SIDEBAR */
        .sidebar { width: 30%; min-width: 350px; background: var(--sidebar-bg); display: flex; flex-direction: column; z-index: 10; border-right: 1px solid #d1d7db; }

        /* CHAT PANEL */
        .chat-panel { flex: 1; display: flex; flex-direction: column; background: var(--chat-bg) url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); position: relative; overflow: hidden; }

        @media (max-width: 768px) {
            .sidebar { width: 100%; min-width: 100%; }
            .chat-panel { position: fixed; top: 0; left: 100%; width: 100%; height: 100%; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
            .chat-panel.active { transform: translateX(-100%); }
        }

        /* COMPONENTS */
        .header { height: 65px; background: var(--header-bg); padding: 0 16px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; border-bottom: 1px solid #d1d7db; }
        .avatar { width: 45px; height: 45px; border-radius: 50%; background: #dfe5e7; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 1px solid rgba(0,0,0,0.05); }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }

        .contact-list { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .contact-item { padding: 12px 16px; display: flex; align-items: center; gap: 15px; cursor: pointer; border-bottom: 1px solid #f5f6f6; }
        .contact-item:active { background-color: #f0f2f5; }

        .message-container { flex: 1; overflow-y: auto; padding: 20px 5%; display: flex; flex-direction: column; gap: 4px; -webkit-overflow-scrolling: touch; }
        .bubble { max-width: 85%; padding: 8px 12px; font-size: 15px; line-height: 1.4; position: relative; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); }
        .bubble.sent { background: var(--msg-out); align-self: flex-end; border-radius: 10px 0px 10px 10px; }
        .bubble.received { background: var(--msg-in); align-self: flex-start; border-radius: 0px 10px 10px 10px; }
        .time { font-size: 10px; color: #667781; margin-top: 4px; display: block; text-align: right; }

        .input-bar { padding: 10px; background: var(--header-bg); display: flex; align-items: center; gap: 10px; }
        .input-wrapper { flex: 1; background: white; border-radius: 25px; padding: 8px 16px; }
        .input-wrapper input { width: 100%; border: none; outline: none; font-size: 16px; }
        .send-btn { width: 45px; height: 45px; border-radius: 50%; background: var(--primary); color: white; border: none; font-size: 20px; cursor: pointer; }

        .fab { position: absolute; bottom: 20px; right: 20px; width: 55px; height: 55px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 3px 6px rgba(0,0,0,0.3); z-index: 15; }

        .modal-bg { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 100; }
        .modal { background: white; width: 85%; max-width: 380px; padding: 25px; border-radius: 20px; }
        .modal input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 10px; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="sidebar">
        <div class="header">
            <div class="avatar" id="myAvatar" onclick="openProfile()"><img id="myAvatarImg" src="https://via.placeholder.com/45"></div>
            <b id="myNameHeader">Chat</b>
            <span style="color: var(--primary); font-weight: bold;" id="myIdDisplay">...</span>
        </div>
        <div class="contact-list" id="contactList"></div>
        <div class="fab" onclick="openAddFriend()">+</div>
    </div>

    <div class="chat-panel" id="chatPanel">
        <div id="activeChatUI" style="display: none; height: 100%; flex-direction: column;">
            <div class="header">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span onclick="goBack()" style="font-size: 24px; cursor: pointer;">‚Üê</span>
                    <div class="avatar" id="activeAvatar"></div>
                    <div><b id="activeName">Nama</b><br><small id="activeStatus" style="color: var(--primary);">online</small></div>
                </div>
                <div style="display: flex; gap: 20px;">
                    <span onclick="startCall(false)">üìû</span>
                    <span onclick="startCall(true)">üìπ</span>
                </div>
            </div>
            <div class="message-container" id="messageBox"></div>
            <form class="input-bar" onsubmit="sendText(event)">
                <div class="input-wrapper"><input type="text" id="chatInp" placeholder="Ketik pesan..." autocomplete="off"></div>
                <button type="submit" class="send-btn">‚û§</button>
            </form>
        </div>
        <div id="noChat" style="margin: auto; text-align: center; color: var(--text-sec);">
            <h2>DARSAP CONNECT</h2>
            <p>Pesan akan muncul otomatis meskipun belum save kontak.</p>
        </div>
    </div>
</div>

<div class="modal-bg" id="profileModal">
    <div class="modal">
        <h3>Profil Saya</h3>
        <center>
            <div class="avatar" style="width: 80px; height: 80px;" onclick="document.getElementById('pInp').click()"><img id="pPrev" src="https://via.placeholder.com/80"></div>
            <input type="file" id="pInp" hidden onchange="previewImg(this)">
        </center>
        <input type="text" id="editName" placeholder="Nama Kamu">
        <button onclick="saveProfile()" style="width:100%;" class="send-btn">Simpan</button>
        <button onclick="hideModals()" style="width:100%; background:gray; margin-top:5px;" class="send-btn">Batal</button>
    </div>
</div>

<div class="modal-bg" id="addModal">
    <div class="modal">
        <h3>Tambah Teman</h3>
        <input type="text" id="fName" placeholder="Nama Panggilan">
        <input type="text" id="fId" placeholder="ID Peer Teman">
        <button onclick="confirmAdd()" style="width:100%;" class="send-btn">Tambah</button>
        <button onclick="hideModals()" style="width:100%; background:gray; margin-top:5px;" class="send-btn">Batal</button>
    </div>
</div>

<script>
    let peer, myID, activeFriend;
    let connections = {};
    let contacts = JSON.parse(localStorage.getItem('darsap_v6_contacts') || '[]');
    let history = JSON.parse(localStorage.getItem('darsap_v6_history') || '{}');
    let myProf = JSON.parse(localStorage.getItem('darsap_v6_prof') || '{"name":"User","photo":""}');

    window.onload = () => {
        myID = localStorage.getItem('darsap_v6_id') || Math.random().toString(36).substr(2, 6);
        localStorage.setItem('darsap_v6_id', myID);
        document.getElementById('myIdDisplay').innerText = myID;
        
        peer = new Peer(myID);
        peer.on('open', id => console.log('ID SAYA:', id));
        
        // FITUR UTAMA: Terima Koneksi dari siapapun
        peer.on('connection', conn => {
            setupIncomingConnection(conn);
        });

        refreshUI();
    };

    function setupIncomingConnection(conn) {
        connections[conn.peer] = conn;

        // Cek apakah ID ini sudah ada di kontak?
        let exists = contacts.find(c => c.id === conn.peer);
        if (!exists) {
            // JIKA BELUM SAVE, OTOMATIS TAMBAHKAN KE DAFTAR CHAT
            contacts.push({ name: "Orang Baru (" + conn.peer + ")", id: conn.peer, photo: "" });
            localStorage.setItem('darsap_v6_contacts', JSON.stringify(contacts));
            renderContacts();
        }

        conn.on('data', data => {
            if(data.type === 'sync') {
                updateFriendInfo(conn.peer, data);
            } else {
                saveMsg(conn.peer, 'received', data.content);
                if(activeFriend?.id === conn.peer) renderMessages();
            }
        });

        conn.on('open', () => {
            conn.send({type:'sync', name: myProf.name, photo: myProf.photo});
        });
    }

    function updateFriendInfo(id, data) {
        let f = contacts.find(c => c.id === id);
        if(f) {
            f.name = data.name;
            f.photo = data.photo;
            localStorage.setItem('darsap_v6_contacts', JSON.stringify(contacts));
            renderContacts();
            if(activeFriend?.id === id) {
                document.getElementById('activeName').innerText = f.name;
                document.getElementById('activeAvatar').innerHTML = f.photo ? `<img src="${f.photo}">` : `<b>${f.name[0]}</b>`;
            }
        }
    }

    function openChat(id) {
        activeFriend = contacts.find(c => c.id === id);
        document.getElementById('noChat').style.display = 'none';
        document.getElementById('activeChatUI').style.display = 'flex';
        document.getElementById('chatPanel').classList.add('active');
        document.getElementById('activeName').innerText = activeFriend.name;
        document.getElementById('activeAvatar').innerHTML = activeFriend.photo ? `<img src="${activeFriend.photo}">` : `<b>${activeFriend.name[0]}</b>`;
        
        renderMessages();
        
        if(!connections[id]) {
            const conn = peer.connect(id);
            setupIncomingConnection(conn);
        }
    }

    function sendText(e) {
        e.preventDefault();
        const inp = document.getElementById('chatInp');
        if(inp.value && connections[activeFriend.id]?.open) {
            connections[activeFriend.id].send({type:'text', content: inp.value});
            saveMsg(activeFriend.id, 'sent', inp.value);
            renderMessages();
            inp.value = "";
        } else if (!connections[activeFriend.id]?.open) {
            alert("Menyambungkan ulang...");
            openChat(activeFriend.id);
        }
    }

    function saveMsg(id, dir, content) {
        if(!history[id]) history[id] = [];
        history[id].push({dir, content, time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})});
        localStorage.setItem('darsap_v6_history', JSON.stringify(history));
        renderContacts();
    }

    function renderContacts() {
        const list = document.getElementById('contactList');
        list.innerHTML = "";
        contacts.forEach(c => {
            const h = history[c.id] || [];
            const lastMsg = h.length > 0 ? h[h.length-1].content : 'Klik untuk chat';
            list.innerHTML += `
                <div class="contact-item" onclick="openChat('${c.id}')">
                    <div class="avatar">${c.photo ? `<img src="${c.photo}">` : `<b>${c.name[0]}</b>`}</div>
                    <div style="flex:1"><b>${c.name}</b><p style="margin:0;font-size:12px;color:gray;">${lastMsg}</p></div>
                </div>`;
        });
    }

    function renderMessages() {
        const box = document.getElementById('messageBox');
        box.innerHTML = "";
        (history[activeFriend.id] || []).forEach(m => {
            box.innerHTML += `<div class="bubble ${m.dir}">${m.content}<span class="time">${m.time}</span></div>`;
        });
        box.scrollTop = box.scrollHeight;
    }

    function refreshUI() {
        document.getElementById('myAvatarImg').src = myProf.photo || 'https://via.placeholder.com/45';
        renderContacts();
    }

    function openProfile() { document.getElementById('profileModal').style.display='flex'; document.getElementById('editName').value = myProf.name; }
    function openAddFriend() { document.getElementById('addModal').style.display='flex'; }
    function hideModals() { document.querySelectorAll('.modal-bg').forEach(m => m.style.display='none'); }
    function goBack() { document.getElementById('chatPanel').classList.remove('active'); }
    
    function previewImg(inp) {
        if(inp.files[0]) {
            let r = new FileReader();
            r.onload = e => document.getElementById('pPrev').src = e.target.result;
            r.readAsDataURL(inp.files[0]);
        }
    }

    function saveProfile() {
        myProf.name = document.getElementById('editName').value;
        myProf.photo = document.getElementById('pPrev').src;
        localStorage.setItem('darsap_v6_prof', JSON.stringify(myProf));
        refreshUI();
        hideModals();
    }

    function confirmAdd() {
        const n = document.getElementById('fName').value;
        const i = document.getElementById('fId').value;
        if(n && i) { contacts.push({name:n, id:i, photo:""}); localStorage.setItem('darsap_v6_contacts', JSON.stringify(contacts)); renderContacts(); hideModals(); }
    }
</script>
</body>
</html>

